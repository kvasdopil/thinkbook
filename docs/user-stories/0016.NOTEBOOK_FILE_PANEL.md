# 0016.notebook-file-panel

## Background

Many users work on multiple experiments or projects simultaneously and need a quick way to switch between them without losing context. Persisting each notebook (cells + AI conversation) as a separate file improves organisation and allows seamless continuation after a page reload.

## User Story

> **As a** data scientist
> **I want** to manage multiple notebook files via a sidebar
> **So that** I can switch between different experiments while keeping their history intact

## Acceptance Criteria

1. A left sidebar is visible that lists notebook files grouped by date (e.g., “Today”, “Yesterday”, older dates). Time is ignored, use only date.
2. Each file item displays its name (default **Untitled**), last-modified timestamp, and is highlighted when open.
3. Clicking a file loads its stored notebook state (cells with `id`, `type`, `content` and full AI conversation including tool calls/results) while excluding runtime state and cell output.
4. A "New File" button at the top of the sidebar creates a fresh file, opens it immediately, and highlights it.
5. A file’s `updatedAt` timestamp changes **only** when:
   - a new chat message is added,
   - a cell’s content is modified, or
   - a cell is deleted.
6. All files are persisted to browser storage via **localforage**, reusing the project’s existing storage utility / configuration.
7. On page reload, the application automatically reopens the last active file and highlights it in the sidebar.
8. All existing notebook functionality (cell execution, AI chat, tool calls) continues to operate within the context of the selected file.

## Technical Notes (optional)

- Store notebook files in localforage under key `notebookFiles`, value is a map `{ [id]: NotebookFile }`.
- `NotebookFile` shape:
  ```ts
  {
    id: string;            // uuid
    createdAt: string;     // ISO date
    updatedAt: string;     // ISO date
    title: string;         // first cell title or "Untitled"
    cells: Cell[];         // id, type, content
    messages: MessagePart[]; // AI + user + tool parts
  }
  ```
- Use a React context/hook (e.g., `useNotebookFiles`) to encapsulate CRUD operations and last-opened file tracking.
- Group files by `updatedAt` date using `date-fns/formatRelative` or similar.
- Use **react-icons** (e.g., `FaPlus`) for the New File button.
- Ensure only debounced writes to localforage to avoid excessive storage operations.
- Make sure we only save each message and cell exactly once, they have unique ids, use it.

## Out of Scope

- Cloud synchronisation or sharing.
- Import/export to external formats (e.g., ipynb).

## Potential Pitfalls

- Accidental updates to `updatedAt` when only cell execution state changes.
- Race conditions during concurrent localforage writes.
- Sidebar performance with large numbers of files.

## Definition of Done

- All acceptance criteria are met.
- Unit / integration tests cover file creation, switching, persistence, and highlight logic.
- Lint & type-check succeed.
- README is updated to include this implemented story.
