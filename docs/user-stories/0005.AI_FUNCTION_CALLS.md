# 0005.ai-function-calls

## Background

The AI chat assistant needs structured ways to interact with notebook cells beyond natural language. Function calls provide deterministic, auditable actions for reading and modifying code cells.

## User Story

> **As a** user chatting with the AI assistant  
> **I want** the AI to directly read and modify my notebook cells  
> **So that** I can get help without manual copy-pasting of code.

## Acceptance Criteria

1. AI can call `listCells()` to get snapshot of all cells with ID, type, text, and output
   returns `[{id, type, text, status, output: ['output lines']}]`
2. AI can call `updateCell(id, text)` to replace cell contents
   returns `{success:true}`
3. Function calls render as conversation balloons with status-colored backgrounds
4. Status indicators: blue (in-progress), green (success), red (failure), orange (cancelled)
5. Each function lives in separate file under `src/ai-functions/` folder
6. Functions use Zod schemas for parameter validation (required by Vercel AI SDK)
7. Frontend implements functions; all tool calls executed via useChat's onToolCall (no backend handlers)
8. Function calls appear exactly once and before the follow-up assistant message

## Technical Notes

- **Schema Definition**: Zod schemas exported as `parameters: zodSchema`
- **Function Structure**: Frontend-only implementation (no backend handlers since we're using Vite)
- **API Integration**: Pass Zod schemas to `tools` parameter in AI SDK configuration
- **Validation**: Use `zodSchema.parse()` before execution
- **Initial Functions**: `listCells()` and `updateCell(id, text)` for MVP
- **CRITICAL**: NEVER render message.content, render message.parts instead, even for assistant messages
- **CRITICAL**: Tool call details are in message.parts with type 'tool-call', render accordingly
- Tool calls implemented in frontend using `onToolCall` callback with manual `addToolResult()` calls
- Configure `sendAutomaticallyWhen: lastAssistantMessageIsCompleteWithToolCalls` for automatic resubmission
- **Components**: MessageToolCallPart component for function call visualization with status colors
- **Architecture**: Each function in separate file under `src/ai-functions/` with index.ts export
- **UI Elements**: Expandable panels for detailed argument/result viewing, formatted JSON display
- **Integration**: useAiChat hook handles tool call execution and routing based on toolName
- **Error Handling**: Graceful error handling for invalid function calls and parameters
- **TypeScript**: Proper interfaces for function return types and parameters

## Out of Scope

- Cancel button for function calls
- Parallel function execution (sequential only)

## Potential Pitfalls

- **Schema mismatch**: Must use Zod schemas, not JSON schemas
- **Parameter validation**: Always validate with Zod before execution

## Definition of Done

- All acceptance criteria are met
- Unit tests for function implementations
- Lint & type-check succeed
- Function calls work with correct status indicators
- No duplication in conversation balloons
- list cells, change the value of a cell, list cells again, make sure list cell calls return different values
