# 0013.settings-modal-gemini-key

## Background

Currently the Gemini AI API key is supplied exclusively through a server-side environment variable, which prevents end-users from dynamically supplying their own key and makes local testing cumbersome. Introducing a UI-based settings modal will allow users to enter and persist their personal Gemini API key directly in the browser, streamlining onboarding and eliminating the need for environment variables.

## User Story

> **As a** developer using the notebook
> **I want** to enter my Gemini AI API key via a settings modal
> **So that** I can immediately start chatting with the AI without editing environment variables or rebuilding the app

## Acceptance Criteria

1. A settings button with a cog icon (react-icons `FiSettings`) is permanently visible in the application header on both desktop and mobile.
2. Clicking the settings button opens a modal window centred on the screen with a translucent backdrop.
3. When the application loads and no Gemini API key is stored, the settings modal automatically opens once to prompt the user.
4. The modal contains:
   - A single text input labelled "Gemini AI Key" (masked as password).
   - "OK" and "Cancel" buttons (keyboard-accessible).
5. Pressing "OK":
   - Saves the entered key to `localStorage` using the `localforage` library **via a dedicated storage helper module** (`src/utils/storage.ts`).
   - Closes the modal.
6. Pressing "Cancel" or the backdrop closes the modal without persisting changes.
7. When a key is stored, every call to the `/api/chat` endpoint includes an `x-gemini-api-key` HTTP header containing the saved key.
8. The backend `/api/chat` route:
   - Reads `x-gemini-api-key` from the request headers.
   - Uses this key when forwarding the request to the Gemini provider.
   - Ignores and does **not** reference any legacy environment variable.
9. If the header is missing, the route responds with HTTP 400 and a descriptive error message. That error message should be displayed in ai chat.
10. All UI elements meet accessibility requirements (ARIA labels, focus trapping in modal, keyboard navigation).
11. Full unit and integration tests cover modal behaviour, storage helper, header injection, backend handling, and automatic modal opening at startup.

## Technical Notes

- Persist key with `localforage.setItem('gemini-api-key', value)` and retrieve with `localforage.getItem`.
- Provide a custom React hook `useGeminiApiKey()` for components to access the key and refresh on change.
- Update existing API wrapper/fetch hook to automatically append the header.
- Remove any references to `process.env.GOOGLE_GENAI_API_KEY`.

## Potential Pitfalls

- Forgetting to await `localforage` promises may lead to race conditions during first request.

## Definition of Done

- All acceptance criteria are met
- Unit / integration tests pass
- Lint & type-check succeed
- README updated to list implemented story
