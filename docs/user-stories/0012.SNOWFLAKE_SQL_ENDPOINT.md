# 0012.snowflake-sql-endpoint

## Background

Internal tools need seamless access to Snowflake data without exposing database credentials to the browser. A backend REST endpoint allows the frontend (and AI agents) to run parameterised SQL queries or paginate existing result sets securely.

## User Story

> **As a** frontend developer or AI agent
> **I want** a secure `/api/snowflake` endpoint that can execute SQL or fetch existing Snowflake result partitions
> **So that** I can retrieve data from Snowflake on demand without handling direct database connections.

## Acceptance Criteria

1. The POST route `/api/snowflake` exists under `src/app/api/snowflake/route.ts`.
2. When the request body contains `{ "sql": "SELECT …" }` the endpoint forwards the query to Snowflake’s REST API and returns the full JSON response.
3. When the request body contains `{ "handle": "<id>", "partition": <number?> }` the endpoint fetches the specified partition of a previously-executed statement and returns the JSON response.
4. The request must include header `x-snowflake-access-token`; if absent the endpoint responds with HTTP 400 and `{ error: "A valid Snowflake access token is required" }`.
5. Missing both `sql` and `handle` fields results in HTTP 400 with `{ error: 'Request must contain either "sql" or "handle"' }`.
6. Errors from the Snowflake API are propagated with HTTP 500 and the error message.
7. The endpoint reads the base URL from environment variable `SNOWFLAKE_BASE_URL`; if undefined it throws a descriptive error.
8. TypeScript types for Snowflake responses are defined (`interface SnowflakeResult { … }`).
9. Unit tests cover successful SQL execution, partition fetch, missing token, missing parameters, and Snowflake error propagation.
10. All existing lint, type-check, and Jest test suites pass.

## Technical Notes

- Query with appropriate headers (`Authorization: Bearer <token>`).
- Snowflake statement timeout set to 30 seconds (`timeout: 30`).
- Convert `partition` to number with fallback to `0`.
- Log server-side errors via `console.error` without exposing stack traces to clients.

## Out of Scope (optional)

- UI components for composing SQL queries.
- Token acquisition/refresh logic (handled elsewhere).
- Streaming results or chunked transfer encoding.
- Client side calls

## Definition of Done

- All acceptance criteria are met.
- Unit / integration tests pass.
- Lint & type-check succeed.
- README updated under “Implemented user-stories”.
