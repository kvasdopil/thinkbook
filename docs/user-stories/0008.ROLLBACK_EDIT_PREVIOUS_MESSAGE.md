# 0008.rollback_edit_previous_message

## Background

Users occasionally make typos, forget information, or want to adjust their phrasing after sending a message. Today the only option is to send a follow-up correction, which can confuse the AI and clutter the notebook. Allowing users to directly edit a past message and rerun the conversation from that point improves clarity and keeps the chat history tidy.

## User Story

> **As a** notebook user
> **I want** to click any of my previous messages to edit and resend it
> **So that** I can roll back the conversation to an earlier point without manual cleanup

## Acceptance Criteria

1. All user messages are visually clickable (pointer cursor + subtle hover effect).
2. Clicking a user message replaces it with an editable textarea, displays a **Send** (`FaPaperPlane`) button and a **Cancel** (`FaTimes`) button.
3. While in edit mode, every conversation item (messages & cells) _after_ the selected message renders at `opacity: 0.7`.
4. Pressing **Esc** or clicking anywhere outside the textarea exits edit mode with no changes and restores full opacity.
5. Pressing **Cancel** behaves the same as (4).
6. Pressing **Send** deletes all subsequent conversation items & cells, inserts the updated message, and dispatches it to the AI backend.
7. After a successful send, the conversation continues normally from the edited point; new AI responses/cells appear chronologically after the edited message.
8. Keyboard navigation is supported: `Tab` focuses **Send**, `Shift+Tab` focuses **Cancel**; both buttons are fully keyboard-operable with appropriate ARIA labels.
9. Feature is fully covered by unit & integration tests simulating user clicks, keypresses, and state assertions.

## Technical Notes (optional)

- Store an `editingMessageId` in global state to drive UI changes.
- Use a transparent overlay or `onBlur` listener to detect outside clicks.
- Apply `opacity-70` Tailwind class conditionally based on message/cell index.
- Deletion logic should update persistence (localforage) and `updatedAt` timestamp.
- Ensure AI function call linkage (e.g. `parentId`, `linkedMessageId`) is recalculated after rollback.

## Out of Scope (optional)

- Editing assistant messages or tool call payloads.
- Version history or multi-level undo beyond the immediate rollback.

## Potential Pitfalls (optional)

- Race conditions if an AI response arrives while the user is editing.
- Consistency of cell execution state after deletion.
- Keyboard focus management when large numbers of cells are present.

## Definition of Done

- All acceptance criteria are met
- Jest test suite passes (including new tests)
- ESLint & TypeScript checks succeed
- README "Implemented user-stories" section is updated
