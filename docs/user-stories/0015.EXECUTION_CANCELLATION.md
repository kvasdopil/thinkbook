# 0015.execution-cancellation

## Background

Long-running Python scripts currently cannot be interrupted once started. Users need the ability to cancel execution of infinite loops, slow scripts, or processes they no longer need.

## User Story

> **As a** user running Python code  
> **I want** to stop script execution immediately when needed  
> **So that** I can cancel infinite loops, slow scripts, or unwanted operations.

## Acceptance Criteria

1. A "Stop" button appears during Python execution (replaces or alongside "Run")
2. Clicking "Stop" immediately shows "Stopping..." state and disables the button
3. Script execution stops immediately using SharedArrayBuffer interruption
4. Output shows cancellation message: "Execution interrupted by user"
5. "Run" button becomes available again after cancellation
6. System displays error when SharedArrayBuffer is unavailable
7. Required security headers are set for SharedArrayBuffer support

## Technical Notes

- **Cancellation Method**: SharedArrayBuffer with `pyodide.setInterruptBuffer()` for immediate stopping. Buffer should be `new Uint8Array(new SharedArrayBuffer(1));`, its important!
- **Security Headers**: `Cross-Origin-Embedder-Policy: require-corp`, `Cross-Origin-Opener-Policy: same-origin`
- **Error Handling**: Standard Python `KeyboardInterrupt` for SharedArrayBuffer cancellation
- **Worker Messages**: `setInterruptBuffer`, `execution-cancelled` message types
- **Interrupt Signal**: Set `buffer[0] = 2` to trigger SIGINT in Pyodide. That should be done in a main thread, because worker cannot receive messages when blocked by pyodide execution.

## Out of Scope

- Fallback cancellation when SharedArrayBuffer unavailable
- Partial execution preservation after cancellation
- Graceful shutdown mechanisms for specific operations
- Automatic security header configuration for all deployments

## Potential Pitfalls

- **Browser compatibility**: SharedArrayBuffer requires specific headers and HTTPS in production
- **Race conditions**: Handle simultaneous cancellation and natural completion
- **Pyodide coupling**: Implementation tied to Pyodide's specific interrupt system
- **Security headers**: May conflict with other policies or third-party integrations
- **Buffer management**: Proper SharedArrayBuffer transfer and cleanup between threads

## Definition of Done

- All acceptance criteria are met
- Unit / integration tests pass
- Lint & type-check succeed
- Cancellation works immediately for any Python code
- Clear error messages when SharedArrayBuffer unavailable
- When cell is cancelled it doesnt show keyboardinterrupt stack, but just ends up in 'cancelled' state, ready to be run again
- When cell throws error is shows error stack in output and ends up in 'error' state, ready to be run again
- That also applies to compilation-lever erros like syntax errors
