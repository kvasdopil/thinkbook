# 0004.ai-chat

## Background

Users need AI assistance while working with code cells to get explanations, ask questions, and receive guidance without leaving their workflow context.

## User Story

> **As a** notebook user  
> **I want** to chat with an AI assistant directly above each code cell  
> **So that** I can get help, explanations, and guidance without leaving the page.

## Acceptance Criteria

1. Chat history panel positioned directly above the code cell
2. Multi-line textarea and "Send" button below history, above code cell
3. Messages appear chronologically (oldest top, newest bottom)
4. Typing and pressing "Send" or ⌘/Ctrl+Enter submits message
5. User message appears immediately with "sending..." state
6. AI response streams from direct API call to Gemini API replacing placeholder
7. Conversation preserved for page session duration
8. Frontend uses Vercel AI SDK with `gemini-2.5-flash` model directly

## Technical Notes

- **API Integration**: Direct frontend API calls using Vercel AI SDK
- **Model**: `createGoogleGenerativeAI` + `streamText` with API key from user settings/localStorage
- **System Prompt**: Constant exported from `prompts/system-prompt.ts` (not filesystem)
- **Message Type**: `ChatMessage { role: 'user' | 'assistant'; content: string }`
- **UI Behavior**: Enter sends, Shift/Ctrl/⌘+Enter adds newline
- **Styling**: Follow existing Tailwind patterns, differentiate user/assistant messages
- use v4 of vercel ai sdk, `https://ai-sdk.dev/docs/migration-guides/migration-guide-5-0#usechat-changes`
- use `useChat` hook from vercel ai sdk
- NEVER render message.content, render message.parts instead, even for assistant messages
- use `status` value of`useChat` to display status of ai conversation at the very end of the message list

## Out of Scope

- Integration with CodeCell execution engine (separate story)

## Definition of Done

- All acceptance criteria are met
- Unit / integration tests pass
- Lint & type-check succeed
- AI chat functional with streaming responses
- Error handling for missing keys and network issues
