# 0004.ai-chat

## Background

Users need AI assistance while working with code cells to get explanations, ask questions, and receive guidance without leaving their workflow context.

## User Story

> **As a** notebook user  
> **I want** to chat with an AI assistant directly above each code cell  
> **So that** I can get help, explanations, and guidance without leaving the page.

## Acceptance Criteria

1. Chat history panel positioned directly above the code cell
2. Multi-line textarea and "Send" button below history, above code cell
3. Messages appear chronologically (oldest top, newest bottom)
4. Typing and pressing "Send" or ⌘/Ctrl+Enter submits message
5. User message appears immediately with "sending..." state
6. AI response streams from direct API call to Gemini API replacing placeholder
7. Conversation preserved for page session duration
8. Frontend uses Vercel AI SDK with `gemini-2.5-flash` model directly

## Technical Notes

- **API Integration**: Direct frontend API calls using Vercel AI SDK
- **Model**: `createGoogleGenerativeAI` + `streamText` with API key from user settings/localStorage
- **System Prompt**: Constant exported from `src/prompts/system-prompt.ts` with helpful AI assistant guidance for code notebook environment
- **Message Rendering**: Use parts-based rendering with `message.parts` array (CRITICAL: NEVER render message.content)
- **UI Behavior**: Enter sends, Shift/Ctrl/⌘+Enter adds newline
- **Styling**: User messages right-aligned, assistant messages left-aligned with Tailwind CSS
- Use v5 of Vercel AI SDK with transport-based architecture
- Use `useChat` hook from Vercel AI SDK with manual input state management
- **CRITICAL**: Render `message.parts` array, handling different part types (text, tool-call, etc.)
- Use `status` value from `useChat` to display conversation status
- **Components**: ChatMessage, MessageTextPart, ChatInput components with proper ARIA labels
- **Integration**: Manual input state management with `useState` for input field
- **UI Requirements**: Smooth scrolling to new messages, responsive design for mobile/desktop
- **Input Validation**: Prevent empty message submissions
- **Tool Calls**: Use `onToolCall` callback with manual `addToolResult()` calls
- **Transport**: Configure with `DefaultChatTransport` pointing to direct API calls

## Out of Scope

- Integration with CodeCell execution engine (separate story)

## Definition of Done

- All acceptance criteria are met
- Unit / integration tests pass
- Lint & type-check succeed
- AI chat functional with streaming responses
- Error handling for missing keys and network issues
